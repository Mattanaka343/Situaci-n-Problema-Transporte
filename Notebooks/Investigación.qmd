---
title: "Factores sociodemográficos y sus efectos en el transporte"
author: "Mateo Yáñez Tanaka"
format:
   html:
     toc: true
     html-math-method: katex
     embed-resources: true
     self-contained-math: true
     df-print: kable
editor: source
bibliography: references.bib
---
# Factores Sociodemográficos y sus efectos en el transporte

Autores: Fernando Pavía-González, Fernando Ramos-Valdez, Jorge Sanchez-Ponce, Mateo Yáñez-Tanaka 

## Abstract

Placeholder text

## Metodología
```{r}
#| eval: false
install.packages('bnlearn')
install.packages('BiocManager')
install.packages('')
BiocManager::install('Rgraphviz')
```

```{r}
library(bnlearn)
library(tidyverse)
set.seed(42)
```

Para entender propiamente los efectos que tienen los factores demográficos en los patrones de transporte de la población propondremos utilizar 4 DAGs (Directed Acyclical Graphs), de las cuales tres estarán basados en la teoría y nuestras hipótesis, y uno será el resultado de la aplicación de hill climbing. La primera DAG es una ideación nuestra basada en nuestras hipótesis y comprensión de los temas.

### Creando las DAGs

Como primera DAG está basada en nuestras hipótesis. Propusimos el modelo preliminar en el cual definimos lo siguiente: La edad y el sexo son los nodos raíz e independientes entre ellos. El estrato socioeconómico esta dado por la edad y el sexo; este mismo se relaciona con la cantidad de vehículos privados que la persona posee y define la población dentro de su localidad. La cantidad de vehículos y la localidad informa el vehículo que se utiliza en un viaje. Finalmente, el día del viaje esta dado por el vehículo que se usa en dicho viaje.

```{r}
data = read.csv('../Data/datos.csv',)
data = data |> select(-id_viv)

int_cols = sapply(data,is.integer)
data[int_cols] = lapply(data[int_cols],as.factor)

dag = empty.graph(nodes = c('L','C','A','M','B','D','E','V','S'))

arc_set = matrix(c("E","C",
                   "S","C",
                   "C","A",
                   "C","M",
                   "C","B",
                   "C","L",
                   "A","V",
                   "M","V",
                   "B","V",
                   "V","D",
                   "L","V"), byrow = TRUE, ncol = 2,
                 dimnames = list(NULL, c("from", "to")))

arcs(dag) = arc_set
graphviz.plot(dag,shape = 'ellipse')
```

La segunda DAG será una versión optimizada de esta, para ello tomaremos la DAG original que formulamos y haremos pruebas sobre la independencia condicional de los arcos que formulamos.
```{r}
arc.strength(dag, data = data, criterion = "mi")
```

Observando los resultados de estas pruebas se puede inferir que se deberían de eliminar los siguientes 2 arcos:
- M a V
- B a V

Ahora generaremos una DAG sin estos nodos.
```{r}
dag2 = empty.graph(nodes = c('L','C','A','M','B','D','E','V','S'))

arc_set2 = matrix(c("E","C",
                   "S","C",
                   "C","A",
                   "C","M",
                   "C","B",
                   "C","L",
                   "A","V",
                   "V","D",
                   "L","V"), byrow = TRUE, ncol = 2,
                 dimnames = list(NULL, c("from", "to")))

arcs(dag2) = arc_set2

graphviz.plot(dag2, shape = "ellipse")
```
La siguiente DAG está dada por investigaciones previas. 

```{r}
dag3 = empty.graph(nodes = c('L','C','A','M','B','D','E','V','S'))

arc_set3 = matrix(c("E","B",
                   "C","A",
                   "C","M",
                   "C","B",
                   "L","A",
                   "B","V",
                   "A","V",
                   "M","V",
                   "S","V",
                   "V","D"
                   ), byrow = TRUE, ncol = 2,
                 dimnames = list(NULL, c("from", "to")))

arcs(dag3) = arc_set3

graphviz.plot(dag3, shape = 'ellipse')
```
### Encontrando la DAG Óptima

La forma óptima para la DAG está dada por un algoritmo de busqueda avaricioso conocido como *Hill Climbing*. Le aplicaremos este algoritmo a nuestros datos para obtener la versión óptima de la DAG.
```{r}
optimal_dag = hc(data)
graphviz.plot(optimal_dag,shape = 'ellipse')
```
Los resultados otorgados por esta DAG indican que la variable más importante es la población de la localidad en donde vive la persona, ésta se relaciona con su clase social y la cantidad de autos que tiene, que a su vez se relaciona con la clase social. La cantidad de autos junto con la clase social informan el vehículo en el que viaja la persona. El vehículo en el que viaja informa la cantidad de motocicletas que poseé un individuo, junto con la clase social informa la edad, y junto con la edad informa el sexo y el día en el que comúnmente viaja la persona.

### Comparando las DAGS
Ahora antes de decidir qué estructura utilizaremos para contestar nuestras preguntas, compararemos las DAGs obteniendo sus puntajes en las pruebas de BIC (Bayesian Information Criterion) y AIC (Akaike Information Criterion).

```{r}
bic_dag_1 = score(dag,data = data, type = 'bic')
bic_dag_2 = score(dag2,data = data, type = 'bic')
bic_dag_3 = score(dag3,data = data, type = 'bic')
bic_opt_dag = score(optimal_dag, data = data, type = 'bic')

print(data.frame(DAG1 = bic_dag_1, DAG2 = bic_dag_2, DAG3 = bic_dag_3, OPTIMAL_DAG = bic_opt_dag))
```
Los resulatados usando la prueba de BIC muestran que en efecto la mejor DAG es la que se obtuvo usando *Hill Climbing*, con la versión optimizada de la primera DAG, y la DAG basada en investigaciones previas tomando valores relativamente cercanos. Ahora probamos utilizando AIC.

```{r}
aic_dag_1 = score(dag,data = data, type = 'aic')
aic_dag_2 = score(dag2,data = data, type = 'aic')
aic_dag_3 = score(dag3,data = data, type = 'aic')
aic_opt_dag = score(optimal_dag, data = data, type = 'aic')

print(data.frame(DAG1 = aic_dag_1, DAG2 = aic_dag_2, DAG3 = aic_dag_3, OPTIMAL_DAG = aic_opt_dag))
```
Los resultados de esta pruba concluyen de la misma forma que la mejor DAG es la obtenida a través de *Hill Climbing*, sin embargo muestran la peor DAG como aquella basada en investigciones previas.

A pesar de su desempeñoo en la segunda prueba, utilizaremos la tercera DAG para contestar las queries debido a su decente desempeño en la primera prueba, interpretabilidad y fundamentación teórica.

### Queries

Para entender propiamente como es que los factores socioeconómicos afectan los patrones de transporte de la población formulamos las siguientes preguntas:
1. ¿Cuál es la probabilidad de que una mujer joven (adultez joven y adolescencia) de estrato social alto use la bicicleta?
```{r}
bn_mle = bn.fit(dag, data =data, method = 'mle')
cpquery(bn_mle,(V=='7'),((S=='2')&((E=='3')|(E=='2'))&(C=='4')))
```

  - La probabilidad de encontrar un evento de este tipo es bastante baja, siendo de alrededor de 1.3%. Mostrando que el uso de la bicicleta parece ser poco común en las mujeres de clase alta.

2. ¿Cuál es la probabilidad de que una persona que vive en una localidad de menos de 2,500 habitantes sea de estrato alto?

```{r}
cpquery(bn_mle, event = (E==4), evidence = (L==4), n = 10^6)
```
  - La probabilidad de que en una comunidad pequeña sea de estrato alto es relativamente alta en aproximadamente 3 de cada 10 personas cumplen con estas características. 

3. ¿Cuál es la probabilidad de que alguien de estrato sociodemográfico bajo (bajo y medio bajo) tenga ya sea una moto, un auto o una bicicleta?
```{r}
cpquery(bn_mle, event = (A==1 | M==1 | B==1), evidence = (E==1 | E==2), n = 10^6)
```

  - La probabilidad de encontrar un evento de este tipo es bastante alta, de alrededor de 44%. Mostrando que bastantes personas de estrato social bajo poseén vehículos privados. 
  
4. Se busca averiguar si las mujeres de edad media y alta, de estrato social bajo tienden a caminar más entre semana en comparación a los hombres con las mismas características.

  - Primero obtendremos la probabilidad de las mujeres.
```{r}
cpquery(bn_mle, event = ((V=='14')&(D=='1')), evidence = ((S=='2')&((E=='4')|(E=='5'))&(C=='1')), n = 10^6)
```
  - Ahora calcularemos la probabilidad de los hombres.
```{r}
cpquery(bn_mle, event = ((V=='14')&(D=='1')), evidence = ((S=='1')&((E=='4')|(E=='5'))&(C=='1')), n = 10^6)
```
  - Al comparar ambos resultados podemos rechazar el enunciado propuesto, puesto que las personas del sexo masculino tuvieron un mayor porcentaje, aunque la probabilidad es extremadamente cercana, dado que la diferencia es apenas de 0.35%.
